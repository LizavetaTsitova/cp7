<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="icon" href="/static/images/logo_2.png">
    <!-- Bootstrap CSS (jsDelivr CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- Bootstrap Bundle JS (jsDelivr CDN) -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="../static/styles/style.css">

</head>
<body style="background-color: #F1F0FA">
<header th:insert="~{blocks/header :: header}"></header>
<div class="content-container">
    <div th:include="blocks/sidebar.html"></div>
    <!-- Таблицы -->
    <div class="container">
        <!--        <h2>Платёжный календарь</h2>-->
        <form th:action="@{/pc/cal_date}" method="get" style="display: flex;">
            <div style="margin-right: 10px;">
                <label for="cal_date">Выберите месяц:</label>
                <input type="month" id="cal_date" name="cal_date" class="date">
            </div>
            <div>
                <button class="btn btn-primary">Выбрать</button>
            </div>
        </form>
        <button id="editButton" onclick="toggleEditing()" class="btn btn-primary" style="margin-bottom: 10px; margin-top: 10px">Разрешить редактирование</button>

        <div th:if="${errorMessage}" class="text-danger" style="font-size: smaller;">
            <p th:text="${errorMessage}"></p>
        </div>

        <div th:unless="${errorMessage}">
            <h4>Ответственный: <span th:text="${owner}"></span></h4>
            <hr>

            <div style="background-color: white; padding: 10px; margin: -10px; margin-bottom: 15px; margin-top: 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); overflow-x: auto;">
                <h2>Таблица доходов</h2>
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>№</th>
                        <th>Категории доходов</th>
                        <th>План, сумма</th>
                        <th>Факт, сумма</th>
                        <th>Разница</th>
                        <th th:each="day : ${#numbers.sequence(1, days)}"
                            th:style="${weekend.contains(day) ? 'background-color: #C6C2EB' : ''}"
                            th:text="${day}"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="category, index : ${categories_inc}">
                        <td th:text="${index.index + 1}"></td>
                        <td th:text="${category.name}"></td>
                        <td th:text="${planAmounts_inc[category.category_id]}"></td>
                        <td th:text="${factAmounts_inc[category.category_id]}"></td>
                        <td th:text="${planAmounts_inc[category.category_id] - factAmounts_inc[category.category_id]}"></td>
                        <td th:each="day : ${#numbers.sequence(1, days)}">
                    <span th:if="${paymentByDay_inc[category.category_id]?.get(day) != null}"
                          th:text="${paymentByDay_inc[category.category_id].get(day)}"
                          class="editable-cell"></span>
                            <span th:unless="${paymentByDay_inc[category.category_id]?.get(day) != null}"></span>
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <th colspan="50">ИТОГИ</th>
                    <tr>
                        <td colspan="5">Итого по неделям</td>
                        <td th:each="week, index : ${weeklyFactAmounts_inc}" th:text="${week}"></td>
                    </tr>
                    <tr>
                        <td colspan="5">Общий итог</td>
                        <td colspan="30" th:text="${totalFactAmount_inc}"></td>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <hr>

            <div style="background-color: white; padding: 10px; margin: -10px; margin-top: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); overflow-x: auto;">
                <h2>Таблица расходов</h2>

                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>№</th>
                        <th>Категории расходов</th>
                        <th>План, сумма</th>
                        <th>Факт, сумма</th>
                        <th>Разница</th>
                        <th th:each="day : ${#numbers.sequence(1, days)}"
                            th:style="${weekend.contains(day) ? 'background-color: #C6C2EB' : ''}"
                            th:text="${day}"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="category, index : ${categories_dec}">
                        <td th:text="${index.index + 1}"></td>
                        <!-- Заполняем колонку "N" по номеру каждой категории по счету -->
                        <td th:text="${category.name}"></td> <!-- Выводим данные из переменной category_inc -->
                        <td th:text="${planAmounts_dec[category.category_id]}"></td>
                        <td th:text="${factAmounts_dec[category.category_id]}"></td>
                        <td th:text="${planAmounts_dec[category.category_id] - factAmounts_dec[category.category_id]}"></td>
                        <td th:each="day : ${#numbers.sequence(1, days)}" class="editable-cell">
                    <span th:if="${paymentByDay_dec[category.category_id]?.get(day) != null}"
                          th:text="${paymentByDay_dec[category.category_id].get(day)}"></span>
                            <span th:unless="${paymentByDay_dec[category.category_id]?.get(day) != null}"> </span>
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <th colspan="50">ИТОГИ</th>
                    <tr>
                        <td colspan="5">Итого по неделям</td>
                        <td th:each="week, index : ${weeklyFactAmounts_dec}" th:text="${week}"></td>
                    </tr>
                    <tr>
                        <td colspan="5">Общий итог</td>
                        <td colspan="30" th:text="${totalFactAmount_dec}"></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>
<div id="popupForm" class="popup-form">
    <div class="popup-content">
        <span class="close" onclick="closePopupForm()">&times;</span>
        <h3>Заполните форму для создания нового платёжного календаря</h3>
        <div th:if="${save_error}" class="text-danger" style="font-size: smaller;">
            <p th:text="${save_error}"></p>
        </div>
        <form th:action="@{/add_pc}">
            <!-- Поля для заполнения -->
            <label for="owner">Кто отвечает за платёжный календарь</label>
            <select class="form-select" id="owner" name="owner">
                <option th:each="userInf : ${usersInfs}" th:value="${userInf.userId}"
                        th:text="${userInf.first_name + ' ' + userInf.last_name}"></option>
            </select>

            <label for="month">Какому месяцу соответствует платёжный календарь?</label>
            <input type="month" id="month" name="month" class="date">

            <button type="submit">Отправить</button>
        </form>
    </div>
</div>
<div id="popupFormIncome" class="popup-form">
    <div class="popup-content">
        <span class="close" onclick="closePopupForm()">&times;</span>
        <h3>Введите прогнозируемые доходы по категориям за следующий месяц</h3>
        <form th:action="@{/add_income}">

        </form>
    </div>
</div>

<script th:inline="javascript">
    /* Отображение всплывающего окна с сообщением об ошибке */
    var save_error = [[${save_error}]];
    if (save_error) {
        alert(save_error);
    }
</script>
<script>
    function openPopupForm() {
        document.getElementById("popupForm").style.display = "block";
    }

    function closePopupForm() {
        document.getElementById("popupForm").style.display = "none";
    }
</script>
<script>
    $(function () {
        $("#datepicker").datepicker({
            dateFormat: "yy-mm",
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true,
            onClose: function (dateText, inst) {
                var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
                var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                $(this).datepicker('setDate', new Date(year, month, 2));

                $.get("/pc/" + dateText)
            }
        });
    });
</script>
<script>
    // Получаем текущую дату
    var today = new Date();

    // Добавляем 7 дней к текущей дате
    var minDate = new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000));

    // Получаем год и месяц следующего месяца
    var nextMonthYear = minDate.getFullYear();
    var nextMonth = minDate.getMonth() + 1; // Месяцы в JavaScript начинаются с 0, поэтому добавляем 1

    // Форматируем значения года и месяца для использования в атрибуте min и max
    var formattedNextMonth = nextMonthYear + '-' + (nextMonth < 10 ? '0' + nextMonth : nextMonth);

    // Устанавливаем ограничения для выбора месяца
    //document.getElementById('month').setAttribute('min', formattedNextMonth);
    document.getElementById('month').setAttribute('max', formattedNextMonth);
</script>
<script>
    function toggleEditing() {
        var editButton = document.getElementById("editButton");
        var editableCells = document.getElementsByClassName("editable-cell");

        if (editButton.innerText === "Разрешить редактирование") {
            editButton.innerText = "Завершить редактирование";
            for (var i = 0; i < editableCells.length; i++) {
                editableCells[i].contentEditable = "true";
            }
        } else {
            editButton.innerText = "Разрешить редактирование";
            for (var i = 0; i < editableCells.length; i++) {
                editableCells[i].contentEditable = "false";
            }
        }
    }
</script>

</body>
</html>